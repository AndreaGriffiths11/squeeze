<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squeeze — Video Compressor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600;700&display=swap');

  :root {
    --bg: #0e0e10;
    --surface: #18181b;
    --surface-hover: #1e1e22;
    --border: #2a2a2e;
    --text: #e4e4e7;
    --text-muted: #71717a;
    --accent: #f97316;
    --accent-dim: #f9731620;
    --green: #22c55e;
    --green-dim: #22c55e20;
    --red: #ef4444;
    --red-dim: #ef444420;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Instrument Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .container {
    max-width: 540px;
    width: 100%;
  }

  h1 {
    font-family: 'DM Mono', monospace;
    font-size: 1.5rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    letter-spacing: -0.02em;
  }

  h1 span { color: var(--accent); }

  .subtitle {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
    font-family: 'DM Mono', monospace;
  }

  /* Settings */
  .settings {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .setting-group {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.75rem 1rem;
  }

  .setting-group label {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
    font-family: 'DM Mono', monospace;
  }

  .setting-group input,
  .setting-group select {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 1rem;
    outline: none;
  }

  .setting-group select option {
    background: var(--surface);
    color: var(--text);
  }

  /* Drop Zone */
  .dropzone {
    border: 2px dashed var(--border);
    border-radius: 14px;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    background: var(--surface);
  }

  .dropzone:hover,
  .dropzone.dragover {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .dropzone-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    opacity: 0.6;
  }

  .dropzone-text {
    font-size: 0.95rem;
    color: var(--text-muted);
  }

  .dropzone-text strong {
    color: var(--text);
  }

  .dropzone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  /* Processing State */
  .processing {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 2rem;
    display: none;
  }

  .processing.active { display: block; }

  .file-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
  }

  .file-name {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 70%;
  }

  .file-size {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    width: 0%;
    transition: width 0.3s ease;
  }

  .progress-fill.done {
    background: var(--green);
  }

  .progress-fill.error {
    background: var(--red);
  }

  .status-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  /* Result */
  .result {
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--border);
    display: none;
  }

  .result.active { display: block; }

  .result-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .stat {
    flex: 1;
    background: var(--bg);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
  }

  .stat-value {
    font-family: 'DM Mono', monospace;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text);
  }

  .stat-value.green { color: var(--green); }
  .stat-value.accent { color: var(--accent); }

  .stat-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-top: 0.2rem;
    font-family: 'DM Mono', monospace;
  }

  .btn-row {
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    flex: 1;
    padding: 0.7rem 1rem;
    border-radius: 8px;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover { opacity: 0.9; }

  .btn-secondary {
    background: var(--border);
    color: var(--text);
  }

  .btn-secondary:hover { background: var(--surface-hover); }

  /* Loading FFmpeg */
  .loader {
    text-align: center;
    padding: 2rem;
    display: none;
  }

  .loader.active { display: block; }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loader-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .error-msg {
    background: var(--red-dim);
    border: 1px solid var(--red);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    color: var(--red);
    margin-top: 1rem;
    display: none;
    font-family: 'DM Mono', monospace;
  }

  .error-msg.active { display: block; }

  .footer {
    margin-top: 2rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: center;
    opacity: 0.5;
  }
</style>
</head>
<body>

<div class="container">
  <h1><span>squeeze</span> .mp4</h1>
  <p class="subtitle">drop a video, get it under your target size</p>

  <div class="settings">
    <div class="setting-group">
      <label>Target Size</label>
      <div style="display:flex;align-items:center;gap:0.25rem;">
        <input type="number" id="targetSize" value="9" min="1" max="100" step="0.5">
        <span style="font-family:'DM Mono',monospace;font-size:0.85rem;color:var(--text-muted)">MB</span>
      </div>
    </div>
    <div class="setting-group">
      <label>Output Format</label>
      <select id="outputFormat">
        <option value="mp4">.mp4</option>
        <option value="webm">.webm</option>
      </select>
    </div>
  </div>

  <!-- Loading FFmpeg -->
  <div class="loader" id="loader">
    <div class="spinner"></div>
    <p class="loader-text">Loading FFmpeg...</p>
  </div>

  <!-- Drop Zone -->
  <div class="dropzone" id="dropzone">
    <div class="dropzone-icon">&#9660;</div>
    <p class="dropzone-text"><strong>Drop your video here</strong><br>or click to browse</p>
    <input type="file" id="fileInput" accept="video/*">
  </div>

  <!-- Processing -->
  <div class="processing" id="processing">
    <div class="file-info">
      <span class="file-name" id="fileName">—</span>
      <span class="file-size" id="fileSize">—</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <p class="status-text" id="statusText">Preparing...</p>

    <div class="result" id="result">
      <div class="result-stats">
        <div class="stat">
          <div class="stat-value" id="originalSize">—</div>
          <div class="stat-label">Original</div>
        </div>
        <div class="stat">
          <div class="stat-value green" id="newSize">—</div>
          <div class="stat-label">Compressed</div>
        </div>
        <div class="stat">
          <div class="stat-value accent" id="reduction">—</div>
          <div class="stat-label">Saved</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="downloadBtn">Download</button>
        <button class="btn btn-secondary" id="resetBtn">New File</button>
      </div>
    </div>
  </div>

  <div class="error-msg" id="errorMsg"></div>

  <p class="footer">runs 100% in your browser. nothing uploaded anywhere.</p>
</div>

<!-- Enables SharedArrayBuffer on GitHub Pages (no server config needed) -->
<script src="https://cdn.jsdelivr.net/npm/coi-serviceworker@0.1.7/coi-serviceworker.min.js"></script>

<script type="module">
  import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/+esm';
  import { fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.2/+esm';

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const processing = document.getElementById('processing');
  const loader = document.getElementById('loader');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const progressFill = document.getElementById('progressFill');
  const statusText = document.getElementById('statusText');
  const result = document.getElementById('result');
  const originalSize = document.getElementById('originalSize');
  const newSize = document.getElementById('newSize');
  const reduction = document.getElementById('reduction');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const errorMsg = document.getElementById('errorMsg');
  const targetSizeInput = document.getElementById('targetSize');
  const outputFormat = document.getElementById('outputFormat');

  let ffmpeg = null;
  let outputBlob = null;
  let outputFileName = '';

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('active');
  }

  function hideError() {
    errorMsg.classList.remove('active');
  }

  async function loadFFmpeg() {
    if (ffmpeg) return;
    loader.classList.add('active');
    dropzone.style.display = 'none';

    try {
      ffmpeg = new FFmpeg();

      ffmpeg.on('log', ({ message }) => {
        // Parse duration and time for progress
        const timeMatch = message.match(/time=(\d+):(\d+):(\d+\.\d+)/);
        if (timeMatch) {
          statusText.textContent = `Encoding... ${timeMatch[1]}:${timeMatch[2]}:${Math.floor(parseFloat(timeMatch[3]))}`;
        }
      });

      ffmpeg.on('progress', ({ progress }) => {
        const pct = Math.min(Math.round(progress * 100), 100);
        progressFill.style.width = pct + '%';
        statusText.textContent = `Compressing... ${pct}%`;
      });

      const coreURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.9/dist/esm/ffmpeg-core.js';
      const wasmURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.9/dist/esm/ffmpeg-core.wasm';

      await ffmpeg.load({
        coreURL,
        wasmURL
      });

      loader.classList.remove('active');
      dropzone.style.display = 'block';
    } catch (e) {
      loader.classList.remove('active');
      dropzone.style.display = 'block';
      showError('Failed to load FFmpeg. Your browser may not support SharedArrayBuffer. Try Chrome or Edge.');
      console.error(e);
    }
  }

  async function compressVideo(file) {
    hideError();
    const targetMB = parseFloat(targetSizeInput.value) || 9;
    const format = outputFormat.value;

    // If already under target, skip
    const fileMB = file.size / (1024 * 1024);
    if (fileMB <= targetMB) {
      showError(`File is already ${formatBytes(file.size)} — under your ${targetMB}MB target.`);
      return;
    }

    dropzone.style.display = 'none';
    processing.classList.add('active');
    result.classList.remove('active');
    progressFill.style.width = '0%';
    progressFill.className = 'progress-fill';

    const baseName = file.name.replace(/\.[^.]+$/, '');
    outputFileName = `${baseName}_squeezed.${format}`;

    fileName.textContent = file.name;
    fileSize.textContent = formatBytes(file.size);
    statusText.textContent = 'Reading file...';

    try {
      const inputName = 'input_video' + file.name.substring(file.name.lastIndexOf('.'));
      const outputName = `output.${format}`;

      await ffmpeg.writeFile(inputName, await fetchFile(file));

      // Calculate target bitrate
      // Target total bitrate = (targetMB * 8 * 1024) / duration_seconds kbps
      // We'll first probe duration, then set bitrate
      statusText.textContent = 'Analyzing video...';

      // Get duration by running a quick probe-like pass
      let durationSec = 0;
      const probeLog = [];
      const origLog = ffmpeg.on('log', ({ message }) => {
        probeLog.push(message);
      });

      try {
        await ffmpeg.exec(['-i', inputName, '-f', 'null', '-t', '0.01', '-']);
      } catch(e) {
        // ffmpeg returns error on null output, that's fine
      }

      // Parse duration from logs
      const allLogs = probeLog.join('\n');
      const durMatch = allLogs.match(/Duration:\s*(\d+):(\d+):(\d+\.\d+)/);
      if (durMatch) {
        durationSec = parseInt(durMatch[1]) * 3600 + parseInt(durMatch[2]) * 60 + parseFloat(durMatch[3]);
      }

      if (durationSec <= 0) {
        // Fallback: estimate from file size assuming ~2Mbps
        durationSec = (file.size * 8) / (2 * 1024 * 1024);
      }

      // Target total bitrate (kbps), reserving 128kbps for audio
      const audioBitrate = 96;
      const targetTotalBitrate = (targetMB * 8 * 1024) / durationSec;
      let videoBitrate = Math.floor(targetTotalBitrate - audioBitrate);

      if (videoBitrate < 50) videoBitrate = 50; // floor

      statusText.textContent = `Compressing at ~${videoBitrate}kbps...`;

      let args;
      if (format === 'webm') {
        args = [
          '-i', inputName,
          '-c:v', 'libvpx',
          '-b:v', videoBitrate + 'k',
          '-c:a', 'libvorbis',
          '-b:a', audioBitrate + 'k',
          '-deadline', 'good',
          '-cpu-used', '4',
          outputName
        ];
      } else {
        args = [
          '-i', inputName,
          '-c:v', 'libx264',
          '-b:v', videoBitrate + 'k',
          '-maxrate', Math.floor(videoBitrate * 1.2) + 'k',
          '-bufsize', Math.floor(videoBitrate * 2) + 'k',
          '-preset', 'fast',
          '-c:a', 'aac',
          '-b:a', audioBitrate + 'k',
          '-movflags', '+faststart',
          outputName
        ];
      }

      await ffmpeg.exec(args);

      const data = await ffmpeg.readFile(outputName);
      outputBlob = new Blob([data.buffer], { type: format === 'webm' ? 'video/webm' : 'video/mp4' });

      // Results
      const savedPct = Math.round((1 - outputBlob.size / file.size) * 100);
      originalSize.textContent = formatBytes(file.size);
      newSize.textContent = formatBytes(outputBlob.size);
      reduction.textContent = savedPct + '%';

      progressFill.style.width = '100%';
      progressFill.classList.add('done');
      statusText.textContent = 'Done!';
      result.classList.add('active');

      // Cleanup
      await ffmpeg.deleteFile(inputName);
      await ffmpeg.deleteFile(outputName);

    } catch (e) {
      progressFill.style.width = '100%';
      progressFill.classList.add('error');
      statusText.textContent = 'Compression failed';
      showError(e.message || 'Something went wrong during compression.');
      console.error(e);
    }
  }

  // Download
  downloadBtn.addEventListener('click', () => {
    if (!outputBlob) return;
    const url = URL.createObjectURL(outputBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = outputFileName;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    processing.classList.remove('active');
    result.classList.remove('active');
    dropzone.style.display = 'block';
    progressFill.style.width = '0%';
    progressFill.className = 'progress-fill';
    hideError();
    outputBlob = null;
    fileInput.value = '';
  });

  // Drag events
  ['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
    });
  });

  dropzone.addEventListener('drop', (e) => {
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('video/')) {
      compressVideo(file);
    } else {
      showError('Please drop a video file.');
    }
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) compressVideo(file);
  });

  // Init
  loadFFmpeg();
</script>

</body>
</html>
