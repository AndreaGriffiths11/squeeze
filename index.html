<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Squeeze ‚Äî Video Compressor</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%F0%9F%8D%8A%3C/text%3E%3C/svg%3E">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600;700&display=swap');

    :root {
      --bg: #0e0e10;
      --surface: #18181b;
      --surface-hover: #1e1e22;
      --border: #2a2a2e;
      --text: #e4e4e7;
      --text-muted: #71717a;
      --accent: #f97316;
      --accent-dim: #f9731620;
      --green: #22c55e;
      --green-dim: #22c55e20;
      --red: #ef4444;
      --red-dim: #ef444420;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Instrument Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .container {
      max-width: 540px;
      width: 100%;
    }

    h1 {
      font-family: 'DM Mono', monospace;
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      letter-spacing: -0.02em;
    }

    h1 span {
      color: var(--accent);
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
      font-family: 'DM Mono', monospace;
    }

    /* Settings */
    .settings {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .setting-group {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem 1rem;
    }

    .setting-group label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
      font-family: 'DM Mono', monospace;
    }

    .setting-group input,
    .setting-group select {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 1rem;
      outline: none;
    }

    .setting-group select option {
      background: var(--surface);
      color: var(--text);
    }

    /* Drop Zone */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      background: var(--surface);
    }

    .dropzone:hover,
    .dropzone.dragover {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .dropzone-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .dropzone-text {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .dropzone-text strong {
      color: var(--text);
    }

    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Processing State */
    .processing {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 2rem;
      display: none;
    }

    .processing.active {
      display: block;
    }

    .file-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }

    .file-name {
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }

    .file-size {
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-fill.done {
      background: var(--green);
    }

    .progress-fill.error {
      background: var(--red);
    }

    .status-text {
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Result */
    .result {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border);
      display: none;
    }

    .result.active {
      display: block;
    }

    .result-stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat {
      flex: 1;
      background: var(--bg);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }

    .stat-value {
      font-family: 'DM Mono', monospace;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text);
    }

    .stat-value.green {
      color: var(--green);
    }

    .stat-value.accent {
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-top: 0.2rem;
      font-family: 'DM Mono', monospace;
    }

    .btn-row {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      flex: 1;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      border: none;
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
    }

    /* Loading FFmpeg */
    .loader {
      text-align: center;
      padding: 2rem;
      display: none;
    }

    .loader.active {
      display: block;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader-text {
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .error-msg {
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      color: var(--red);
      margin-top: 1rem;
      display: none;
      font-family: 'DM Mono', monospace;
    }

    .error-msg.active {
      display: block;
    }

    .footer {
      margin-top: 2rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: center;
      opacity: 0.5;
    }

    .contribute-link {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      color: inherit;
      text-decoration: none;
    }

    .contribute-link:hover {
      color: var(--text);
    }

    .contribute-link svg {
      width: 0.62rem;
      height: 0.62rem;
      fill: currentColor;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>üçä <span>squeeze</span> .mp4</h1>
    <p class="subtitle">drop a video, get it under your target size</p>

    <div class="settings">
      <div class="setting-group">
        <label>Target Size</label>
        <div style="display:flex;align-items:center;gap:0.25rem;">
          <input type="number" id="targetSize" value="9" min="1" max="100" step="0.5">
          <span style="font-family:'DM Mono',monospace;font-size:0.85rem;color:var(--text-muted)">MB</span>
        </div>
      </div>
      <div class="setting-group">
        <label>Output Format</label>
        <select id="outputFormat">
          <option value="mp4">.mp4</option>
          <option value="webm">.webm</option>
        </select>
      </div>
    </div>

    <!-- Loading FFmpeg -->
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <p class="loader-text">Loading FFmpeg...</p>
    </div>

    <!-- Drop Zone -->
    <div class="dropzone" id="dropzone">
      <div class="dropzone-icon">&#9660;</div>
      <p class="dropzone-text"><strong>Drop your video here</strong><br>or click to browse</p>
      <input type="file" id="fileInput" accept="video/*">
    </div>

    <!-- Processing -->
    <div class="processing" id="processing">
      <div class="file-info">
        <span class="file-name" id="fileName">‚Äî</span>
        <span class="file-size" id="fileSize">‚Äî</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="status-text" id="statusText">Preparing...</p>

      <div class="result" id="result">
        <div class="result-stats">
          <div class="stat">
            <div class="stat-value" id="originalSize">‚Äî</div>
            <div class="stat-label">Original</div>
          </div>
          <div class="stat">
            <div class="stat-value green" id="newSize">‚Äî</div>
            <div class="stat-label">Compressed</div>
          </div>
          <div class="stat">
            <div class="stat-value accent" id="reduction">‚Äî</div>
            <div class="stat-label">Saved</div>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="downloadBtn">Download</button>
          <button class="btn btn-secondary" id="resetBtn">New File</button>
        </div>
      </div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <p class="footer">
      runs 100% in your browser. nothing uploaded anywhere. <span style="opacity:0.5">v5</span> ¬∑
      <a class="contribute-link" href="https://github.com/andreagriffiths11/squeeze" target="_blank" rel="noopener noreferrer" aria-label="Contribute to this project on GitHub">
        <svg viewBox="0 0 16 16" aria-hidden="true">
          <path d="M8 0C3.58 0 0 3.58 0 8a8 8 0 0 0 5.47 7.59c.4.07.55-.17.55-.38v-1.34C3.8 14.35 3.33 12.9 3.33 12.9c-.36-.92-.88-1.17-.88-1.17-.72-.49.06-.48.06-.48.79.06 1.21.82 1.21.82.71 1.2 1.86.85 2.31.64.07-.51.28-.85.5-1.05-1.78-.2-3.64-.89-3.64-3.98 0-.88.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.13 0 0 .67-.22 2.2.82a7.5 7.5 0 0 1 4 0c1.53-1.04 2.2-.82 2.2-.82.44 1.11.16 1.93.08 2.13.51.56.82 1.27.82 2.15 0 3.1-1.87 3.78-3.65 3.98.29.25.54.73.54 1.48v2.2c0 .21.15.46.55.38A8 8 0 0 0 16 8c0-4.42-3.58-8-8-8Z" />
        </svg>
        contribute
      </a>
    </p>
  </div>

  <!-- Enables SharedArrayBuffer on GitHub Pages (no server config needed) -->
  <script src="https://cdn.jsdelivr.net/npm/coi-serviceworker@0.1.7/coi-serviceworker.min.js" integrity="sha384-6ZObzDaJvaBCZYhNbvdjOA05QZ1ZV4WWSj8SL95G+gde8L6LIBuyfIQvTJtvpRt0" crossorigin="anonymous"></script>

  <script type="module">
    import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/+esm';

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const processing = document.getElementById('processing');
    const loader = document.getElementById('loader');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const progressFill = document.getElementById('progressFill');
    const statusText = document.getElementById('statusText');
    const result = document.getElementById('result');
    const originalSize = document.getElementById('originalSize');
    const newSize = document.getElementById('newSize');
    const reduction = document.getElementById('reduction');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const errorMsg = document.getElementById('errorMsg');
    const targetSizeInput = document.getElementById('targetSize');
    const outputFormat = document.getElementById('outputFormat');

    let ffmpeg = null;
    let outputBlob = null;
    let outputFileName = '';
    let compressStart = 0;
    let totalDuration = 0;

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.classList.add('active');
    }

    function hideError() {
      errorMsg.classList.remove('active');
    }

    async function loadFFmpeg() {
      if (ffmpeg) return;
      loader.classList.add('active');
      dropzone.style.display = 'none';

      try {
        ffmpeg = new FFmpeg();

        ffmpeg.on('log', ({ message }) => {
          const timeMatch = message.match(/time=(\d+):(\d+):(\d+\.\d+)/);
          if (timeMatch && totalDuration > 0) {
            const currentSec = parseInt(timeMatch[1]) * 3600 + parseInt(timeMatch[2]) * 60 + parseFloat(timeMatch[3]);
            const progress = Math.min(currentSec / totalDuration, 1);
            const pct = Math.min(Math.round(progress * 100), 100);
            progressFill.style.width = pct + '%';
            let eta = '';
            if (compressStart && progress > 0.05) {
              const elapsed = (Date.now() - compressStart) / 1000;
              const remaining = Math.round((elapsed / progress) * (1 - progress));
              if (remaining >= 60) {
                eta = ` ‚Äî ~${Math.floor(remaining / 60)}m ${remaining % 60}s left`;
              } else {
                eta = ` ‚Äî ~${remaining}s left`;
              }
            }
            statusText.textContent = `Compressing... ${pct}%${eta}`;
          }
        });

        // Fetch the class worker script and rewrite relative imports to absolute CDN URLs,
        // then create a blob URL to avoid cross-origin Worker restriction
        const ffmpegBase = 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/esm/';
        const classWorkerSrc = await (await fetch(ffmpegBase + 'worker.js')).text();
        const classWorkerFixed = classWorkerSrc.replace(/from\s*["']\.\/([^"']+)["']/g, `from "${ffmpegBase}$1"`);
        const classWorkerBlob = new Blob([classWorkerFixed], { type: 'text/javascript' });
        const classWorkerURL = URL.createObjectURL(classWorkerBlob);

        const canUseThreads = typeof SharedArrayBuffer !== 'undefined';

        if (canUseThreads) {
          const coreURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.9/dist/esm/ffmpeg-core.js';
          const wasmURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.9/dist/esm/ffmpeg-core.wasm';
          const workerURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.9/dist/esm/ffmpeg-core.worker.js';
          await ffmpeg.load({ classWorkerURL, coreURL, wasmURL, workerURL });
          console.log('[squeeze] Loaded multi-threaded FFmpeg');
        } else {
          const coreURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.9/dist/esm/ffmpeg-core.js';
          const wasmURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.9/dist/esm/ffmpeg-core.wasm';
          await ffmpeg.load({ classWorkerURL, coreURL, wasmURL });
          console.log('[squeeze] Loaded single-threaded FFmpeg (SharedArrayBuffer unavailable)');
        }

        loader.classList.remove('active');
        dropzone.style.display = 'block';
      } catch (e) {
        loader.classList.remove('active');
        dropzone.style.display = 'block';
        showError('Failed to load FFmpeg: ' + (e.message || 'Unknown error. Try refreshing or using Chrome/Edge.'));
        console.error(e);
      }
    }

    const MAX_FILE_SIZE_MB = 4096;

    async function compressVideo(file) {
      hideError();
      const targetMB = parseFloat(targetSizeInput.value) || 9;
      const format = outputFormat.value;
      const fileMB = file.size / (1024 * 1024);

      if (fileMB > MAX_FILE_SIZE_MB) {
        showError(`File is ${formatBytes(file.size)} \u2014 too large for in-browser compression. Use a desktop tool like HandBrake or FFmpeg CLI.`);
        return;
      }

      if (fileMB <= targetMB) {
        showError(`File is already ${formatBytes(file.size)} \u2014 under your ${targetMB}MB target.`);
        return;
      }

      dropzone.style.display = 'none';
      processing.classList.add('active');
      result.classList.remove('active');
      progressFill.style.width = '0%';
      progressFill.className = 'progress-fill';

      const baseName = file.name.replace(/\.[^.]+$/, '');
      outputFileName = `${baseName}_squeezed.${format}`;

      fileName.textContent = file.name;
      fileSize.textContent = formatBytes(file.size);

      const outputName = `output.${format}`;
      const mountDir = '/input';
      let mounted = false;
      let inputPath = '';
      let useMount = false;

      try {
        statusText.textContent = 'Loading file...';

        // Strategy 1: WORKERFS mount (zero-copy, works for large files)
        try {
          try { await ffmpeg.createDir(mountDir); } catch (_) { }
          await ffmpeg.mount('WORKERFS', { files: [file] }, mountDir);
          mounted = true;
          useMount = true;
          inputPath = `${mountDir}/${file.name}`;
          console.log('[squeeze] Using WORKERFS mount for input');
        } catch (mountErr) {
          console.warn('[squeeze] WORKERFS mount failed:', mountErr);

          // Strategy 2: Read file into memory
          statusText.textContent = 'Reading file into memory...';
          const ext = file.name.substring(file.name.lastIndexOf('.'));
          inputPath = 'input_video' + ext;

          let fileData;
          try {
            fileData = new Uint8Array(await file.arrayBuffer());
          } catch (e) {
            throw new Error(`Cannot read ${formatBytes(file.size)} file into memory. Close other browser tabs, or use a desktop tool like HandBrake.`);
          }

          try {
            await ffmpeg.writeFile(inputPath, fileData);
          } catch (e) {
            throw new Error(`Could not load file into compressor (${formatBytes(file.size)}). Your browser ran out of memory. Close other tabs and try again.`);
          }
          fileData = null;
        }

        // Probe duration
        statusText.textContent = 'Analyzing video...';
        let durationSec = 0;
        const probeLog = [];

        const probeUnsub = ffmpeg.on('log', ({ message }) => {
          probeLog.push(message);
        });

        try {
          await ffmpeg.exec(['-i', inputPath, '-f', 'null', '-t', '0.01', '-']);
        } catch (e) { /* expected */ }

        if (typeof probeUnsub === 'function') probeUnsub();

        const allLogs = probeLog.join('\n');
        const durMatch = allLogs.match(/Duration:\s*(\d+):(\d+):(\d+\.\d+)/);
        if (durMatch) {
          durationSec = parseInt(durMatch[1]) * 3600 + parseInt(durMatch[2]) * 60 + parseFloat(durMatch[3]);
        }
        if (durationSec <= 0) {
          durationSec = (file.size * 8) / (2 * 1024 * 1024);
        }
        totalDuration = durationSec;

        const audioBitrate = 96;
        const targetTotalBitrate = (targetMB * 8 * 1024) / durationSec;
        let videoBitrate = Math.floor(targetTotalBitrate - audioBitrate);
        if (videoBitrate < 50) videoBitrate = 50;

        // Auto-downscale when the target bitrate is too low for the source resolution
        let targetHeight = 0;
        const resMatch = allLogs.match(/Stream.*Video.*\s(\d{2,5})x(\d{2,5})/);
        if (resMatch) {
          const srcHeight = parseInt(resMatch[2]);
          if (videoBitrate < 500) targetHeight = Math.min(srcHeight, 480);
          else if (videoBitrate < 1500) targetHeight = Math.min(srcHeight, 720);
          else if (videoBitrate < 4000) targetHeight = Math.min(srcHeight, 1080);
          if (targetHeight >= srcHeight) targetHeight = 0;
          if (targetHeight) console.log(`[squeeze] Downscaling ${srcHeight}p ‚Üí ${targetHeight}p for ${videoBitrate}kbps`);
        }

        statusText.textContent = `Compressing at ~${videoBitrate}kbps${targetHeight ? ' (downscaled to ' + targetHeight + 'p)' : ''}...`;

        const vf = targetHeight ? `scale=-2:${targetHeight}:flags=lanczos` : null;

        if (format === 'webm') {
          let args = ['-i', inputPath, '-sn', '-dn'];
          if (vf) args.push('-vf', vf);
          args.push('-c:v', 'libvpx', '-b:v', videoBitrate + 'k', '-c:a', 'libvorbis', '-b:a', audioBitrate + 'k', '-deadline', 'good', '-cpu-used', '4', outputName);

          compressStart = Date.now();
          var exitCode = await ffmpeg.exec(args);
        } else {
          // Pass 1: analyze
          statusText.textContent = 'Pass 1/2 ‚Äî analyzing...';
          let pass1 = ['-i', inputPath, '-sn', '-dn'];
          if (vf) pass1.push('-vf', vf);
          pass1.push('-c:v', 'libx264', '-b:v', videoBitrate + 'k', '-maxrate', Math.floor(videoBitrate * 1.2) + 'k', '-bufsize', Math.floor(videoBitrate * 2) + 'k', '-preset', 'slow', '-pass', '1', '-an', '-f', 'null', '-');

          compressStart = Date.now();
          await ffmpeg.exec(pass1);

          // Pass 2: encode
          statusText.textContent = 'Pass 2/2 ‚Äî encoding...';
          compressStart = Date.now();
          let pass2 = ['-i', inputPath, '-sn', '-dn'];
          if (vf) pass2.push('-vf', vf);
          pass2.push('-c:v', 'libx264', '-b:v', videoBitrate + 'k', '-maxrate', Math.floor(videoBitrate * 1.2) + 'k', '-bufsize', Math.floor(videoBitrate * 2) + 'k', '-preset', 'slow', '-pass', '2', '-c:a', 'aac', '-b:a', audioBitrate + 'k', '-movflags', '+faststart', outputName);

          var exitCode = await ffmpeg.exec(pass2);

          // Clean up pass log files
          try { await ffmpeg.deleteFile('ffmpeg2pass-0.log'); } catch (_) { }
          try { await ffmpeg.deleteFile('ffmpeg2pass-0.log.mbtree'); } catch (_) { }
        }
        if (exitCode !== 0) {
          throw new Error('FFmpeg exited with an error. The video format may not be supported, or the file may be corrupted.');
        }

        const data = await ffmpeg.readFile(outputName);
        outputBlob = new Blob([data.buffer], { type: format === 'webm' ? 'video/webm' : 'video/mp4' });

        const savedPct = Math.round((1 - outputBlob.size / file.size) * 100);
        originalSize.textContent = formatBytes(file.size);
        newSize.textContent = formatBytes(outputBlob.size);
        reduction.textContent = savedPct + '%';

        progressFill.style.width = '100%';
        progressFill.classList.add('done');
        statusText.textContent = 'Done!';
        result.classList.add('active');

        try { await ffmpeg.deleteFile(outputName); } catch (_) { }
        if (!useMount) {
          try { await ffmpeg.deleteFile(inputPath); } catch (_) { }
        }

      } catch (e) {
        progressFill.style.width = '100%';
        progressFill.classList.add('error');
        statusText.textContent = 'Compression failed';

        let msg = e.message || 'Something went wrong during compression.';
        if (msg.includes('Code=-1') || msg.includes('code -1')) {
          msg = `File could not be processed (${formatBytes(file.size)}). Try a smaller file or use a desktop tool like HandBrake.`;
        }
        showError(msg);
        console.error(e);
      } finally {
        if (mounted) {
          try { await ffmpeg.unmount(mountDir); } catch (_) { }
        }
      }
    }

    // Download
    downloadBtn.addEventListener('click', () => {
      if (!outputBlob) return;
      const url = URL.createObjectURL(outputBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = outputFileName;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Reset
    resetBtn.addEventListener('click', () => {
      processing.classList.remove('active');
      result.classList.remove('active');
      dropzone.style.display = 'block';
      progressFill.style.width = '0%';
      progressFill.className = 'progress-fill';
      hideError();
      outputBlob = null;
      fileInput.value = '';
    });

    // Drag events
    ['dragenter', 'dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('video/')) {
        compressVideo(file);
      } else {
        showError('Please drop a video file.');
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) compressVideo(file);
    });

    // Init
    loadFFmpeg();
  </script>

</body>

</html>
